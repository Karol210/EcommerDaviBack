---
description: ConfiguraciÃ³n centralizada de Feign Clients con Parameter Store y retry
globs: ["**/config/FeignClientConfig.java"]
alwaysApply: true
---

# âš™ï¸ Feign Client Config - ConfiguraciÃ³n Transversal

## ðŸ“‹ TL;DR

- âœ… UNA configuraciÃ³n para TODOS los Feign Clients
- âœ… URL y API Key desde Parameter Store automÃ¡ticamente
- âœ… Timeouts: 10s connect, 30s read
- âœ… Retry: 3 intentos con backoff exponencial
- âŒ NO crear configuraciones personalizadas por cliente

## ðŸš¨ Reglas Principales

1. `FeignClientConfig` es la ÃšNICA configuraciÃ³n para todos los clientes
2. Extrae nombre del servicio quitando sufijo `-client`
3. Busca URL en `${services.{nombre}.url}` y consulta Parameter Store
4. Agrega API Key automÃ¡ticamente si existe `${services.{nombre}.api-key}`
5. Timeouts y retry policy son globales para todos los clientes

## ðŸ“Š Referencia RÃ¡pida - Flujo de ConfiguraciÃ³n

| Paso | AcciÃ³n | DescripciÃ³n |
|------|--------|-------------|
| 1 | Extraer nombre | `parameter-client` â†’ `parameter` |
| 2 | Construir property | `services.parameter.url` |
| 3 | Leer yml | Obtener ruta Parameter Store |
| 4 | Consultar AWS | Obtener URL real desde Parameter Store |
| 5 | Aplicar URL | Configurar en `requestTemplate` |
| 6 | API Key opcional | Si existe, agregar header `x-api-key` |

## âœ… Ejemplos

### Ejemplo 1: Estructura BÃ¡sica

```java
@Slf4j
@Configuration
@RequiredArgsConstructor
public class FeignClientConfig {

    private final ParameterStoreUtil parameterStoreUtil;
    private final Environment environment;

    @Bean
    public RequestInterceptor feignClientInterceptor() {
        return requestTemplate -> {
            final String clientName = requestTemplate.feignTarget().name();
            
            log.debug("ðŸ” Procesando cliente Feign: {}", clientName);
            
            try {
                String serviceName = extractServiceName(clientName);
                configureUrl(requestTemplate, serviceName);
                addApiKeyIfExists(requestTemplate, serviceName);
                
                log.debug("âœ… Cliente {} configurado exitosamente", clientName);
                
            } catch (Exception e) {
                log.error("âŒ Error configurando cliente Feign {}: {}", 
                    clientName, e.getMessage(), e);
                throw new RuntimeException("Error configurando cliente Feign: " + clientName, e);
            }
        };
    }

    private String extractServiceName(String clientName) {
        if (clientName.endsWith("-client")) {
            return clientName.substring(0, clientName.length() - "-client".length());
        }
        return clientName;
    }
}
```

### Ejemplo 2: Configurar URL

```java
private void configureUrl(feign.RequestTemplate requestTemplate, String serviceName) {
    try {
        // 1. Construir property key: services.{serviceName}.url
        String propertyKey = String.format("services.%s.url", serviceName);
        
        // 2. Obtener ruta del Parameter Store desde yml
        String parameterStoreKey = environment.getProperty(propertyKey);
        
        if (parameterStoreKey == null || parameterStoreKey.trim().isEmpty()) {
            log.debug("No se encontrÃ³ configuraciÃ³n de URL para: {}", propertyKey);
            return;
        }
        
        // 3. Obtener URL desde Parameter Store
        String baseUrl = parameterStoreUtil.getParameterStoreValues(parameterStoreKey);
        
        if (baseUrl != null && !baseUrl.trim().isEmpty()) {
            String cleanUrl = sanitizeUrl(baseUrl);
            
            // 4. Aplicar URL al request
            requestTemplate.target(cleanUrl);
            
            log.info("ðŸ“¡ URL configurada para {}: {}", serviceName, cleanUrl);
        }
        
    } catch (Exception e) {
        log.error("Error obteniendo URL para servicio: {}", serviceName, e);
        throw e;
    }
}

private String sanitizeUrl(String baseUrl) {
    if (baseUrl == null || baseUrl.trim().isEmpty()) {
        throw new IllegalStateException("URL no puede estar vacÃ­a");
    }
    return baseUrl.trim().replaceAll("/$", "");
}
```

### Ejemplo 3: Timeouts y Retry

```java
@Bean
public Request.Options feignRequestOptions() {
    return new Request.Options(
        10000, TimeUnit.MILLISECONDS, // Connect timeout: 10 segundos
        30000, TimeUnit.MILLISECONDS, // Read timeout: 30 segundos
        true                          // Follow redirects
    );
}

@Bean
public Retryer feignRetryer() {
    return new Retryer.Default(
        100,  // Initial interval: 100ms
        1000, // Max interval: 1 segundo
        3     // Max attempts: 3 intentos
    );
}
```

## ðŸš« Restricciones

1. **NO** crear mÃºltiples clases de configuraciÃ³n Feign
2. **NO** modificar URLs manualmente en interceptores personalizados
3. **NO** agregar API Keys manualmente en servicios
4. **NO** usar valores hardcodeados de timeout
5. **NO** omitir logs de configuraciÃ³n (info/debug)
6. **NO** lanzar excepciones genÃ©ricas sin contexto
7. **NO** ignorar errores de Parameter Store
8. **NO** modificar el nombre del header de API Key (`x-api-key` es estÃ¡ndar)

## âœ… ValidaciÃ³n AutomÃ¡tica

Cursor debe detectar:

- âŒ MÃºltiples clases anotadas con `@Configuration` para Feign
- âŒ Configuraciones personalizadas en `@FeignClient(configuration = ...)`
- âŒ Headers de autenticaciÃ³n agregados manualmente en servicios
- âŒ Timeouts hardcodeados en clientes individuales
- âŒ Falta de `@Slf4j` en `FeignClientConfig`
- âŒ Falta de manejo de excepciones en interceptor
- âŒ URL no sanitizada (con slashes finales)

## ðŸŽ¯ Objetivo + Regla de Oro

**Objetivo**: ConfiguraciÃ³n centralizada y automÃ¡tica de todos los Feign Clients desde Parameter Store, sin duplicaciÃ³n de cÃ³digo.

**REGLA DE ORO**: "UNA configuraciÃ³n para TODOS. El nombre del cliente (`X-client`) define el servicio (`X`). URL y API Key se buscan automÃ¡ticamente en `services.X.*`."

---

## ðŸ”§ Estrategia de Reintentos

```
Intento 1 â†’ Falla â†’ Espera 100ms
Intento 2 â†’ Falla â†’ Espera 200ms (duplica)
Intento 3 â†’ Falla â†’ Espera 400ms (duplica)
Intento 4 â†’ ERROR FINAL
```

**RazÃ³n**: Fallas transitorias de red son comunes. 3 intentos con backoff exponencial minimizan impacto sin sobrecargar servicios externos.

> **Ver tambiÃ©n**: 
> - [servicios-02-feign-client.mdc](./servicios-02-feign-client.mdc) - Crear Feign Clients
> - [servicios-01-creacion-servicios.mdc](./servicios-01-creacion-servicios.mdc) - Uso en servicios
