---
description: Gu√≠a para crear Feign Clients con configuraci√≥n autom√°tica desde Parameter Store
globs: ["**/client/**/*.java"]
alwaysApply: true
---

# üåê Feign Client - Integraci√≥n con APIs Externas

## üìã TL;DR

- ‚úÖ Configuraci√≥n autom√°tica desde Parameter Store v√≠a `FeignClientConfig`
- ‚úÖ Nombre del cliente termina en `-client`
- ‚úÖ URL din√°mica: `${services.{nombre}.url}`
- ‚úÖ API Key opcional: `${services.{nombre}.api-key}`
- ‚ùå NO hardcodear URLs

## üö® Reglas Principales

1. **Nomenclatura**: `@FeignClient(name="xxx-client")` + interfaz `External{Nombre}Client` (sin guiones)
2. **Ubicaci√≥n**: Paquete `external/` junto con servicios external
3. **URL din√°mica**: `${services.{nombre}.url}` sin sufijo `-client`
4. **Config transversal**: `configuration = FeignClientConfig.class` (obligatorio)
5. **@PathVariable**: Siempre con nombre expl√≠cito ‚Ä¢ API Key autom√°tica si existe en yml

## üìä Referencia R√°pida - Convenciones

| Elemento | Convenci√≥n | Ejemplo |
|----------|-----------|---------|
| Ubicaci√≥n | `service/{dominio}/external/` | `service/healthinsurance/external/` |
| Nombre interfaz | `External{Nombre}Client` | `ExternalHealthInsurancePremiumClient` |
| Nombre en @FeignClient | `{nombre}-client` (guiones) | `health-insurance-premium-client` |
| URL property | `${services.{servicio}.url}` | `${services.health-insurance-premium.url}` |
| API Key property | `${services.{servicio}.api-key}` | `${services.health-insurance-premium.api-key}` |
| Configuration | `FeignClientConfig.class` | Siempre incluir |
| PathVariable | `@PathVariable("nombre")` | Con nombre expl√≠cito |

## ‚úÖ Ejemplos

### Ejemplo 1: Cliente SIN API Key

```java
package com.bolivar.tienda.digital.transaccional.comunes.ms.service.shorturl.external;

import com.bolivar.tienda.digital.transaccional.comunes.ms.config.FeignClientConfig;
import com.bolivar.tienda.digital.transaccional.comunes.ms.dto.ChannelParameterDto;
import com.bolivar.tienda.digital.transaccional.comunes.ms.models.Response;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;

/**
 * Cliente Feign para consumir par√°metros de canal del servicio de Tienda Digital Commons.
 * La URL se configura din√°micamente desde Parameter Store.
 *
 * @author Team Tienda Digital
 * @since 1.0.0
 */
@FeignClient(
    name = "parameter-client",                    // ‚úÖ Con guiones en @FeignClient
    url = "${services.parameter.url}",            // ‚úÖ Property key en yml
    configuration = FeignClientConfig.class       // ‚úÖ Config transversal
)
public interface ExternalParameterClient {        // ‚úÖ Prefijo External + sin guiones

    /**
     * Consulta par√°metros de canal por nombre de producto.
     *
     * @param channelParametersProduct Nombre del producto
     * @return Respuesta con par√°metros del canal
     */
    @GetMapping("${services.parameter.endpoints.channel-parameters}")
    Response<ChannelParameterDto> consultChannelParameters(
        @PathVariable("channelParametersProduct") String channelParametersProduct
    );
}
```

**application.yml**:
```yaml
services:
  parameter:
    url: tienda/endpoint                         # Llave en Parameter Store
    endpoints:
      channel-parameters: /api/v1/parametros/{channelParametersProduct}
```

### Ejemplo 2: Cliente CON API Key

```java
@FeignClient(
    name = "notificaciones-client",
    url = "${services.notificaciones.url}",
    configuration = FeignClientConfig.class
)
public interface NotificacionesClient {
    
    @PostMapping("/enviar")
    NotificacionResponse enviarNotificacion(@RequestBody NotificacionRequest request);
}
```

**application.yml**:
```yaml
services:
  notificaciones:
    url: notificaciones/api/endpoint
    api-key: notificaciones/api/key  # üîë API Key requerida
```

### Ejemplo 3: Uso en Servicio

```java
@Slf4j
@Service
@RequiredArgsConstructor
public class MiServicioImpl implements MiServicio {

    private final ParameterClient parameterClient;  // ‚úÖ Inyecci√≥n de interfaz

    public void procesarDatos() {
        log.info("Llamando al servicio externo...");
        
        // ‚úÖ La URL y API key se configuran autom√°ticamente
        Response<ChannelParameterDto> response = 
            parameterClient.consultChannelParameters("producto");
        
        // Procesar respuesta...
    }
}
```

## üö´ Restricciones

1. **NO** usar URLs hardcodeadas en `@FeignClient(url = "https://...")`
2. **NO** omitir `configuration = FeignClientConfig.class`
3. **NO** usar nombres de cliente sin sufijo `-client` en la anotaci√≥n `@FeignClient`
4. **NO** colocar el cliente en el paquete `client/` (debe ir en `external/`)
5. **NO** usar `@PathVariable` sin nombre expl√≠cito
6. **NO** agregar headers de API Key manualmente (se agrega autom√°ticamente)
7. **NO** crear configuraciones personalizadas por cliente (usar la transversal)
8. **NO** omitir JavaDoc en la interfaz del cliente
9. **NO** crear m√∫ltiples clientes para el mismo servicio
10. **NO** usar guiones en el nombre de la interfaz (solo en `@FeignClient.name`)

## ‚úÖ Validaci√≥n Autom√°tica

Cursor debe detectar:

- ‚ùå `@FeignClient` sin `name` terminado en `-client`
- ‚ùå Cliente creado en paquete `client/` en lugar de `external/`
- ‚ùå Nombre de interfaz sin prefijo `External` (debe ser `ExternalHealthInsurancePremiumClient`)
- ‚ùå Nombre de interfaz con guiones (debe ser `ExternalHealthInsurancePremiumClient`, NO `External-Health-Insurance-Premium-Client`)
- ‚ùå `@FeignClient` con URL hardcodeada
- ‚ùå Falta de `configuration = FeignClientConfig.class`
- ‚ùå `@PathVariable` sin nombre: `@PathVariable String param`
- ‚ùå Headers de autenticaci√≥n agregados manualmente
- ‚ùå Falta de JavaDoc en la interfaz
- ‚ùå Property `${services.X.url}` no definida en `application.yml`

## üéØ Objetivo + Regla de Oro

**Objetivo**: Crear clientes Feign estandarizados con configuraci√≥n autom√°tica desde Parameter Store, sin duplicaci√≥n de l√≥gica de autenticaci√≥n.

**REGLA DE ORO**: "Cliente en `external/`, nombre interfaz `External{Nombre}Client` (prefijo External + sin guiones), nombre en anotaci√≥n con guiones (`-client`). URL desde `${services.X.url}`, config transversal `FeignClientConfig.class`. Si necesita API Key, agr√©gala en yml y se aplicar√° autom√°ticamente."

---

## üìã Checklist de Creaci√≥n

- [ ] Interface creada con nombre `External{Nombre}Client` (prefijo External)
- [ ] Cliente ubicado en el paquete `external/` junto con el servicio external
- [ ] `@FeignClient` con `name` terminado en `-client`
- [ ] `@FeignClient` con `url = "${services.xxx.url}"`
- [ ] `configuration = FeignClientConfig.class` agregado
- [ ] JavaDoc completo en la interfaz
- [ ] `@PathVariable` con nombre expl√≠cito
- [ ] Configuraci√≥n agregada en `application.yml`
- [ ] Par√°metros creados en Parameter Store (dev, stage, prod)
- [ ] API Key agregada si es necesaria (SecureString)
- [ ] Tests unitarios con mock del cliente
- [ ] Validar que el servicio inyecta la interfaz correctamente

> **Ver tambi√©n**: 
> - [servicios-03-feign-config.mdc](./servicios-03-feign-config.mdc) - Configuraci√≥n de `FeignClientConfig`
> - [servicios-01-creacion-servicios.mdc](./servicios-01-creacion-servicios.mdc) - Uso en servicios
