---
description: Manejo de excepciones personalizadas con c√≥digos de error estandarizados
globs: ["**/exception/**/*.java", "**/controller/ExceptionHandlerController.java"]
alwaysApply: true
---

# ‚ö†Ô∏è Manejo de Excepciones Personalizadas

## üìã TL;DR

- ‚úÖ Una excepci√≥n personalizada por funcionalidad (extends `RuntimeException`)
- ‚úÖ C√≥digo de error formato: `TDTC-XX-NNNN`
- ‚úÖ Constantes en `Constants.java`
- ‚úÖ Handler en `ExceptionHandlerController`
- ‚úÖ **Clean Code:** Excepciones de negocio se propagan autom√°ticamente - NO capturarlas si solo se relanzan
- ‚úÖ **Solo capturar excepciones t√©cnicas** para convertirlas a negocio
- ‚úÖ **Handlers con ‚â•3 condiciones:** Extraer determinaci√≥n de HttpStatus en m√©todo privado con JavaDoc
- ‚úÖ **Para m√≥dulos completos:** Organizar en `exception/{modulo}/`
- ‚ùå NO usar excepciones gen√©ricas
- ‚ùå NO usar `catch (BusinessException e) { throw e; }` (antipatr√≥n)
- ‚ùå NO usar operadores ternarios anidados en handlers

## üö® Reglas Principales

1. Cada funcionalidad tiene su propia excepci√≥n (`*Exception extends RuntimeException`)
2. Incluir campo `errorCode` con formato `TDTC-XX-NNNN`
3. Dos constructores: simple (mensaje + c√≥digo) y con causa (mensaje + c√≥digo + Throwable)
4. Constantes de mensajes y c√≥digos en `Constants.java`
5. Handler espec√≠fico en `ExceptionHandlerController` con `@ExceptionHandler`
6. **Clean Code:** Excepciones de negocio (`RuntimeException`) NO se capturan si solo se relanzan - se propagan autom√°ticamente
7. **Solo capturar excepciones t√©cnicas** (`IOException`, `SQLException`, `IllegalStateException`) para convertirlas a excepciones de negocio
8. **Handlers complejos (‚â•3 condiciones):** Extraer l√≥gica de determinaci√≥n de HttpStatus en m√©todo privado con JavaDoc descriptivo
9. **Para m√≥dulos completos:** Organizar en `exception/{modulo}/` (ver Organizaci√≥n Modular)

## üìä Referencia R√°pida - Formato de C√≥digos

| M√≥dulo | Prefijo | Ejemplo | Descripci√≥n |
|--------|---------|---------|-------------|
| Short URL | `TDTC-SU-` | `TDTC-SU-0001` | Errores de acortamiento de URLs |
| Transaction | `TDTC-TX-` | `TDTC-TX-0001` | Errores de transacciones |
| Cumulus | `TDTC-CU-` | `TDTC-CU-0001` | Errores de c√∫mulos/acumulaci√≥n |
| Parameter | `TDTC-PA-` | `TDTC-PA-0001` | Errores de parametrizaci√≥n |

**Formato**: `TDTC-XX-NNNN`
- `TDTC` = Tienda Digital Transaccional Comunes
- `XX` = Identificador del m√≥dulo (2 letras)
- `NNNN` = N√∫mero secuencial (4 d√≠gitos: 0001, 0002, ...)

### Decisi√≥n: ¬øExtraer l√≥gica de HttpStatus?

| Condiciones | Estructura | Acci√≥n |
|---|---|---|
| 1-2 condiciones | `if-else` simple | ‚úÖ Mantener inline |
| ‚â•3 condiciones | `if-else` m√∫ltiple o ternario anidado | üö® **EXTRAER en m√©todo privado** |
| L√≥gica reutilizable | Cualquiera | ‚úÖ Extraer en m√©todo privado |
| L√≥gica testeable | Cualquiera | ‚úÖ Extraer en m√©todo privado |

**Beneficios de extracci√≥n:**
- üéØ **SRP**: Handler solo construye Response, m√©todo privado determina status
- üéØ **Legibilidad**: Estructura if-return clara vs ternario anidado
- üéØ **Testeable**: M√©todo independiente puede testearse aisladamente
- üéØ **Mantenible**: Agregar c√≥digos = agregar un `if` simple

## ‚úÖ Ejemplos

### Ejemplo 1: Crear Excepci√≥n Personalizada

```java
package com.bolivar.tienda.digital.transaccional.comunes.ms.exception;

import lombok.Getter;

/**
 * Excepci√≥n personalizada para operaciones de acortamiento de URLs.
 * Se lanza cuando ocurren errores en el proceso de acortamiento de URLs,
 * tales como errores de parametrizaci√≥n, servicio externo o almacenamiento.
 *
 * @author Team Tienda Digital
 * @since 1.0.0
 */
@Getter
public class ShortUrlException extends RuntimeException {

    /**
     * C√≥digo de error espec√≠fico de la excepci√≥n
     */
    private final String errorCode;

    /**
     * Constructor para crear una excepci√≥n con mensaje y c√≥digo de error.
     *
     * @param message Mensaje descriptivo del error
     * @param errorCode C√≥digo de error espec√≠fico (ver Constants.CODE_*)
     */
    public ShortUrlException(String message, String errorCode) {
        super(message);
        this.errorCode = errorCode;
    }

    /**
     * Constructor para crear una excepci√≥n con mensaje, c√≥digo de error y causa.
     *
     * @param message Mensaje descriptivo del error
     * @param errorCode C√≥digo de error espec√≠fico (ver Constants.CODE_*)
     * @param cause Excepci√≥n original que caus√≥ este error
     */
    public ShortUrlException(String message, String errorCode, Throwable cause) {
        super(message, cause);
        this.errorCode = errorCode;
    }
}
```

### Ejemplo 2: Definir Constantes

```java
public class Constants {
    
    // Short URL - Error Messages
    public static final String ERROR_SHORT_URL_SAVE = "Error al guardar URL acortada en base de datos";
    public static final String ERROR_SHORT_URL_EXTERNAL_SERVICE = "Error al llamar servicio externo de acortamiento";
    public static final String ERROR_SHORT_URL_PARAMETRIZACION = "Error al resolver par√°metros de configuraci√≥n";
    
    // Short URL - Error Codes
    public static final String CODE_PARAMETRIZACION_NOT_FOUND = "TDTC-SU-0001";
    public static final String CODE_EXTERNAL_SERVICE_ERROR = "TDTC-SU-0002";
    public static final String CODE_DATABASE_ERROR = "TDTC-SU-0003";
}
```

### Ejemplo 3: Clean Code - Propagaci√≥n Natural de Excepciones

**Principio:** Excepciones de negocio (`RuntimeException`) se propagan autom√°ticamente. SOLO capturar excepciones t√©cnicas para convertirlas.

| Situaci√≥n | Acci√≥n | Justificaci√≥n |
|---|---|---|
| `CartException`, `ProductException` | ‚ùå NO capturar | Se propagan autom√°ticamente |
| `IOException`, `SQLException` | ‚úÖ Capturar y convertir | Excepciones t√©cnicas |
| `catch (E e) { throw e; }` | ‚ùå Antipatr√≥n | No agrega valor |
| Logging antes de propagar | ‚úÖ V√°lido | Agrega contexto |

**Ejemplo - Conversi√≥n de t√©cnica a negocio:**
```java
public String shortenUrl(String longUrl) {
    try {
        return urlShortenerClient.shortenUrl(longUrl);
    } catch (FeignException e) {  // ‚úÖ T√©cnica ‚Üí negocio
        log.error("Error servicio externo: {}", e.getMessage());
        throw new ShortUrlException(ERROR_EXTERNAL, CODE_EXTERNAL, e);
    }
}
```

### Ejemplo 4: Extraer L√≥gica de HttpStatus en M√©todo Privado (‚â•3 condiciones)

**Tabla comparativa:**

| Aspecto | ‚ùå Ternario Anidado | ‚úÖ M√©todo Privado |
|---|---|---|
| L√≠neas en handler | 15 | 1 |
| Legibilidad | Dif√≠cil | Clara |
| Mantenibilidad | Agregar c√≥digo complejo | Agregar `if` simple |
| Testeable | Solo con handler | Independiente |

**C√≥digo optimizado:**
```java
@ExceptionHandler({CartException.class})
public Response<Object> handleCartException(CartException e, HttpServletRequest request) {
    log.error("CartException: URL={} | Code={} | Msg={}", 
            request.getRequestURI(), e.getErrorCode(), e.getMessage());
    
    HttpStatus status = determineCartExceptionStatus(e.getErrorCode());  // ‚úÖ Delega
    
    return Response.builder()
            .failure(true)
            .code(status.value())
            .errorCode(e.getErrorCode())
            .message(e.getMessage())
            .timestamp(String.valueOf(System.currentTimeMillis()))
            .build();
}

private HttpStatus determineCartExceptionStatus(String errorCode) {
    if (CODE_NOT_FOUND_CODES.contains(errorCode)) return HttpStatus.NOT_FOUND;
    if (CODE_CART_AUTH_REQUIRED.equals(errorCode)) return HttpStatus.UNAUTHORIZED;
    if (CODE_USER_NOT_CLIENT.equals(errorCode)) return HttpStatus.FORBIDDEN;
    return HttpStatus.BAD_REQUEST;
}
```

## üö´ Restricciones

1. **NO** usar excepciones gen√©ricas (`RuntimeException`, `Exception`) - crear personalizadas con `errorCode`
2. **NO** capturar excepciones de negocio solo para relanzarlas (`catch (E e) { throw e; }`)
3. **NO** usar `catch (Exception e)` gen√©rico que oculta excepciones espec√≠ficas
4. **NO** hardcodear mensajes de error (usar `Constants.java`)
5. **NO** perder contexto de causa ra√≠z (constructor con `Throwable cause`)
6. **NO** omitir logs al convertir excepciones t√©cnicas a negocio
7. **NO** usar c√≥digos sin formato `TDTC-XX-NNNN` ni duplicarlos entre m√≥dulos
8. **NO** omitir JavaDoc en excepciones personalizadas
9. **NO** crear excepciones de m√≥dulos completos en ra√≠z `exception/` (usar `exception/{modulo}/`)
10. **NO** usar operadores ternarios anidados (‚â•3 condiciones) en handlers - extraer m√©todo privado

## üì¶ Organizaci√≥n Modular de Excepciones

### Cu√°ndo Usar Paquetes Espec√≠ficos

| Criterio | Ra√≠z `exception/` | Paquete `exception/{modulo}/` |
|----------|-------------------|-------------------------------|
| Excepci√≥n transversal | ‚úÖ S√≠ (ej: `AllieException`) | ‚ùå No |
| Excepci√≥n de m√≥dulo simple | ‚úÖ S√≠ (ej: `CipherException`) | ‚ùå No |
| **Excepci√≥n de m√≥dulo completo** | ‚ùå No | ‚úÖ S√≠ (controller + service + dto) |
| M√∫ltiples excepciones relacionadas | ‚ùå No | ‚úÖ S√≠ (agrupar en paquete) |

**Estructura Modular:**
```
exception/
‚îú‚îÄ‚îÄ {modulo}/
‚îÇ   ‚îî‚îÄ‚îÄ {Modulo}Exception.java
‚îî‚îÄ‚îÄ ExceptionHandlerController.java (ra√≠z, handler global)
```

**Import correcto:**
```java
// ‚úÖ CORRECTO: Import desde paquete espec√≠fico
import com.bolivar.tiendaseguros.ms.exception.processconfig.ProcessConfigurationException;
```

## ‚úÖ Validaci√≥n Autom√°tica

Cursor debe detectar:

- ‚ùå `catch (E e) { throw e; }` - Capturar solo para relanzar
- ‚ùå `catch (Exception e)` gen√©rico que oculta excepciones espec√≠ficas
- ‚ùå `throw new RuntimeException(...)` sin excepci√≥n personalizada
- ‚ùå Mensajes hardcodeados: `throw new Exception("Error al...")`
- ‚ùå Excepciones sin campo `errorCode` o sin constructor con `Throwable cause`
- ‚ùå C√≥digos sin formato `TDTC-XX-NNNN` o duplicados
- ‚ùå Handlers sin `@ExceptionHandler` o sin logs
- ‚ùå Operadores ternarios anidados (‚â•3 condiciones) sin extraer m√©todo privado

## üéØ Objetivo + Regla de Oro

**Objetivo**: Manejo consistente de errores con trazabilidad completa mediante c√≥digos √∫nicos y contexto detallado, siguiendo principios de Clean Code.

**REGLA DE ORO**: "Una excepci√≥n por funcionalidad con c√≥digo `TDTC-XX-NNNN`. Excepciones de negocio (`RuntimeException`) se propagan autom√°ticamente - NO capturarlas. SOLO capturar t√©cnicas (`IOException`, `SQLException`) para convertir a negocio. Handlers con ‚â•3 condiciones ‚Üí extraer m√©todo privado."

---

> **Ver tambi√©n**: 
> - [servicios-01-creacion-servicios.mdc](./servicios-01-creacion-servicios.mdc) - Uso en servicios
