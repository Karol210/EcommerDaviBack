---
description: OrganizaciÃ³n por capacidades en servicios externos, DTOs y Mappers
globs: ["**/service/**/external/**/*.java", "**/dto/**/*.java", "**/mapper/**/*.java"]
alwaysApply: true
---

# ğŸ—‚ï¸ OrganizaciÃ³n por Capacidades - Servicios, DTOs y Mappers

## ğŸ“‹ TL;DR

- âœ… **OBLIGATORIO**: ServiceImpl con â‰¥3 mÃ©todos privados â†’ Separar en `validation/` + `builder/`
- âœ… **OBLIGATORIO**: Validation/Transactional con â‰¥2 dominios â†’ Organizar en subcarpetas por dominio (product/, user/, cart/, document/, role/, status/, common/) SIN coordinador intermedio
- âœ… **OBLIGATORIO**: ServiceImpl inyecta subcapacidades directamente por dominio (NO coordinadores que solo delegan)
- âœ… **Request/Response principales** en `models/` SIN sufijo "Dto" â€¢ **DTOs auxiliares** en `dto/` CON "Dto"
- âœ… Estructura paralela: `service/{capacidad}/` â†’ `dto/{capacidad}/` â†’ `mapper/{capacidad}/`
- âœ… ServiceImpl inyecta subcapacidades directamente â€¢ Sin capas de delegaciÃ³n innecesarias
- âŒ NO coordinadores intermedios que solo delegan â€¢ NO mezclar dominios en un servicio
- âŒ NO estructura inconsistente entre service/dto/mapper â€¢ NO mezclar models/ con dto/

## ğŸš¨ Reglas Principales

1. **SeparaciÃ³n Obligatoria en Servicios CRUD**: Si `ServiceImpl` tiene â‰¥3 mÃ©todos auxiliares privados, separar en capacidades (`validation/`, `builder/`) con interfaces propias
2. **OrganizaciÃ³n por Dominio (OBLIGATORIO)**: Si `validation/` o `transactional/` tienen mÃ©todos de â‰¥2 dominios diferentes (product, user, cart, document, role, status, common), **OBLIGATORIO** organizar en subcarpetas por dominio SIN coordinador intermedio. ServiceImpl inyecta subcapacidades especÃ­ficas directamente
3. **SeparaciÃ³n Models vs DTOs**: Request/Response principales en `models/` SIN sufijo "Dto". DTOs auxiliares (anidados, cÃ¡lculos, resÃºmenes) en `dto/` CON sufijo "Dto"
4. **Sin Coordinadores Intermedios**: NO crear servicios que solo delegan. ServiceImpl debe inyectar subcapacidades especÃ­ficas directamente
5. **CohesiÃ³n Alta**: Todos los archivos relacionados con una capacidad/dominio juntos (Client, Service, ServiceImpl, DTOs, Mapper)
6. **Estructura Paralela**: `service/{dominio}/{capacidad}/` se refleja en `dto/{dominio}/{capacidad}/` y `mapper/{dominio}/{capacidad}/`
7. **Subcapacidades**: Para responsabilidades independientes (>50 lÃ­neas), usar subcarpetas (`validation/rules/`, `validation/storage/`)

## ğŸ“Š Referencia RÃ¡pida

### DecisiÃ³n de OrganizaciÃ³n

| Criterio | RaÃ­z `external/` | Subcarpeta `external/{capacidad}/` |
|----------|:----------------:|:---------------------------------:|
| Una sola capacidad | âœ… SÃ­ | âŒ No (sobrecarga innecesaria) |
| MÃºltiples capacidades (â‰¥2) | âŒ No | âœ… SÃ­ (mejor organizaciÃ³n) |
| Capacidades independientes | âŒ No | âœ… SÃ­ (bajo acoplamiento) |
| Funcionalidades relacionadas | âœ… SÃ­ | âŒ No |

### Patrones Comunes de Capacidades

| Capacidad | Responsabilidad | Archivos en carpeta | Archivos en `dto/` | ExposiciÃ³n |
|-----------|-----------------|---------------------|-------------------|:----------:|
| **`validation`** â­ | **Validaciones de negocio (CRUD)** | **`*ValidationService`, `*ValidationServiceImpl`** | **Ninguno (usa DTOs existentes)** | **âŒ Interna** |
| **`builder`** â­ | **ConstrucciÃ³n/transformaciÃ³n (CRUD)** | **`*BuilderService`, `*BuilderServiceImpl`** | **Ninguno (usa DTOs existentes)** | **âŒ Interna** |
| **`transactional`** â­ | **Acceso a datos (consultas y persistencia)** | **`*TransactionalService`, `*TransactionalServiceImpl`** | **Ninguno (usa entidades)** | **âŒ Interna** |
| `auth` | AutenticaciÃ³n y autorizaciÃ³n | `*AuthClient`, `*AuthService`, `*AuthServiceImpl` | `*TokenDto`, `*CredentialsDto` | âŒ Interna |
| `questions` | Consulta de datos | `*QuestionsClient`, `*QuestionsService`, `*QuestionsServiceImpl` | `*RequestDto`, `*ResponseDto` | âŒ Interna |
| `validation` | ValidaciÃ³n de reglas (External) | `*ValidationClient`, `*ValidationService`, `*ValidationServiceImpl` | `*ValidationRequestDto`, `*ResultDto` | âŒ Interna |
| `processing` | Procesamiento de transacciones | `*ProcessingClient`, `*ProcessingService`, `*ProcessingServiceImpl` | `*ProcessRequestDto`, `*ProcessResponseDto` | âŒ Interna |
| `storage` | Almacenamiento de datos | `*StorageService`, `*StorageServiceImpl` | Opcional segÃºn caso | âŒ Interna |
| `rules` | Reglas de negocio | `*RulesService`, `*RulesServiceImpl` | Ninguno (usa DTOs existentes) | âŒ Interna |
| `organization` | Ordenar/agrupar datos | `*OrganizationService`, `*OrganizationServiceImpl` | Ninguno (usa DTOs existentes) | âŒ Interna (ver regla 01) |

**â­ CAPACIDADES OBLIGATORIAS**: `validation/`, `builder/` y `transactional/` deben crearse cuando un servicio CRUD tiene â‰¥3 mÃ©todos auxiliares privados.

**ğŸ¯ OrganizaciÃ³n por Dominio en Validation/Transactional:**

Cuando `validation/` o `transactional/` tienen mÃ©todos de mÃºltiples dominios, organizar en subcarpetas:

| Dominio | Responsabilidad | Ejemplo Validation | Ejemplo Transactional |
|---------|----------------|-------------------|----------------------|
| **`product/`** | ValidaciÃ³n/acceso a productos | `validateProductExists()`, `validateProductActive()` | `findProductById()` |
| **`user/`** | ValidaciÃ³n/acceso a usuarios | `validateUserRoleExists()`, `getUserRoleIdFromEmail()` | `findUserById()`, `existsUserRoleById()` |
| **`cart/`** | ValidaciÃ³n/acceso a carritos | `validateCartExists()`, `validateItemBelongsToUser()` | `findCartById()`, `saveCartItem()` |
| **`common/`** | Validaciones genÃ©ricas | `validateQuantity()`, `validateDateRange()` | âŒ No aplica en transactional |

**ğŸ“Œ ServiceImpl inyecta subcapacidades directamente SIN coordinador intermedio**

### Subcapacidades - OrganizaciÃ³n Anidada

**CuÃ¡ndo Usar Subcapacidades:**
- âœ… Un mÃ³dulo tiene mÃºltiples responsabilidades bien definidas
- âœ… Cada subcapacidad tiene lÃ³gica significativa (>50 lÃ­neas)
- âœ… Las responsabilidades son independientes entre sÃ­
- âŒ NO crear subcapacidades si solo hay mÃ©todos pequeÃ±os (mantener en un servicio)

| Nivel | Uso | Ejemplo |
|---|---|---|
| **MÃ³dulo Principal** | Coordinador de flujo | `validation/InsurabilityValidationServiceImpl` |
| **Subcapacidad 1** | Responsabilidad especÃ­fica | `validation/rules/InsurabilityValidationRulesServiceImpl` |
| **Subcapacidad 2** | Responsabilidad especÃ­fica | `validation/storage/InsurabilityValidationStorageServiceImpl` |

### OrganizaciÃ³n de Mappers

| UbicaciÃ³n Servicio | UbicaciÃ³n Mapper | Ejemplo |
|-------------------|------------------|---------|
| `service/{dominio}/` | `mapper/{dominio}/` | `service/premiumCalculation/` â†’ `mapper/PremiumCalculationMapper` |
| `service/{dominio}/{capacidad}/` | `mapper/{dominio}/{capacidad}/` | `service/insurability/validation/` â†’ `mapper/insurability/validation/InsurabilityValidationMapper` |
| `service/{dominio}/external/{capacidad}/` | `mapper/{dominio}/{capacidad}/` | `service/insurability/external/auth/` â†’ `mapper/insurability/auth/AuthMapper` |

**Reglas de Mappers:**
- âœ… Mapper sigue la estructura de carpetas del servicio/dominio
- âœ… Nomenclatura: `{Dominio}{Capacidad}Mapper` (ej: `InsurabilityValidationMapper`)
- âœ… AnotaciÃ³n `@Component` para inyecciÃ³n de dependencias
- âœ… MÃ©todos pÃºblicos para transformaciones principales, privados para auxiliares
- âŒ NO crear mappers en raÃ­z de `mapper/` si el servicio tiene subcarpetas
- âŒ NO duplicar lÃ³gica de mapeo entre servicios (crear mapper compartido si es necesario)

### OrganizaciÃ³n de Models vs DTOs

**SeparaciÃ³n CrÃ­tica: Request/Response en `models/` - DTOs Auxiliares en `dto/`**

| Tipo | UbicaciÃ³n | Nomenclatura | PropÃ³sito |
|---|---|---|---|
| **Request principales** | `models/` o `models/{capacidad}/` | SIN sufijo "Dto" | Entrada de endpoints REST |
| **Response principales** | `models/` o `models/{capacidad}/` | SIN sufijo "Dto" | Salida de endpoints REST |
| **DTOs auxiliares** | `dto/{dominio}/{capacidad}/` | CON sufijo "Dto" | Objetos anidados, cÃ¡lculos, resÃºmenes |
| **Modelos genÃ©ricos** | `models/` raÃ­z | Sin sufijo | Response wrapper, utils |

**Estructura Ejemplo:**

```
models/
â”œâ”€â”€ cart/                              ğŸ“¦ Capacidad relacionada
â”‚   â”œâ”€â”€ CartItemBatchRequest.java     âœ… Request (batch) - SIN "Dto"
â”‚   â””â”€â”€ CartItemResponse.java         âœ… Response - SIN "Dto"
â”‚
â”œâ”€â”€ CartCreateResponse.java           âœ… Response simple - SIN "Dto"
â”œâ”€â”€ CartItemRequest.java              âœ… Request simple - SIN "Dto"
â””â”€â”€ Response.java                     âœ… Modelo genÃ©rico

dto/{dominio}/
â”œâ”€â”€ batch/                             ğŸ“¦ DTOs auxiliares batch
â”‚   â””â”€â”€ CartItemBatchItemDto.java     âœ… Item dentro de batch - CON "Dto"
â”‚
â”œâ”€â”€ item/                              ğŸ“¦ DTOs auxiliares cÃ¡lculos
â”‚   â””â”€â”€ CartItemCalculationDto.java   âœ… CÃ¡lculos de item - CON "Dto"
â”‚
â””â”€â”€ summary/                           ğŸ“¦ DTOs auxiliares resumen
    â””â”€â”€ CartSummaryDto.java            âœ… Resumen carrito - CON "Dto"
```

**Criterios de ClasificaciÃ³n:**

| Â¿Es Request/Response principal? | UbicaciÃ³n | Nomenclatura |
|:---:|---|---|
| âœ… SÃ­ | `models/` o `models/{capacidad}/` | `CartItemRequest`, `CartItemResponse` |
| âŒ No (DTO auxiliar/anidado) | `dto/{dominio}/{capacidad}/` | `CartItemBatchItemDto`, `CartSummaryDto` |

**Reglas:**
- âœ… Request/Response principales en `models/` SIN "Dto"
- âœ… DTOs auxiliares (anidados, cÃ¡lculos, resÃºmenes) en `dto/` CON "Dto"
- âœ… Usar subcarpeta `models/{capacidad}/` cuando hay mÃºltiples Request/Response relacionados (ej: `models/cart/`)
- âœ… DTOs auxiliares mantienen estructura paralela en `dto/{dominio}/{capacidad}/`
- âŒ NO mezclar Request/Response con DTOs auxiliares en la misma carpeta
- âŒ NO usar sufijo "Dto" en Request/Response principales

**Ejemplo de Uso:**

```java
// âœ… Request principal en models/ - SIN "Dto"
@RestController
public class CartItemController {
    @PostMapping("/add")
    public Response<String> addItem(@Valid @RequestBody CartItemRequest request) {
        // CartItemRequest estÃ¡ en models/
    }
}

// âœ… DTO auxiliar en dto/ - CON "Dto"
public class CartSummaryDto {
    private List<CartItemResponse> items;        // Response principal
    private CartItemCalculationDto totals;       // DTO auxiliar
}
```

### Beneficios de OrganizaciÃ³n por Capacidades

| Beneficio | Impacto |
|-----------|---------|
| **Alta CohesiÃ³n** | Archivos relacionados juntos (`external/auth/` agrupa todo lo de autenticaciÃ³n) |
| **Bajo Acoplamiento** | Cambios en `auth/` no afectan `questions/` |
| **Escalabilidad** | Agregar `validation/` sin tocar cÃ³digo existente |
| **Mantenibilidad** | Desarrolladores encuentran cÃ³digo rÃ¡pidamente |
| **Testing** | Tests separados por capacidad (`AuthServiceTest`, `QuestionsServiceTest`) |

## âœ… Ejemplos

### Ejemplo 1: Estructura Completa por Capacidades - Insurability

```
service/insurability/
â”œâ”€â”€ external/
â”‚   â”œâ”€â”€ auth/                                    ğŸ” Capacidad: AutenticaciÃ³n OAuth2
â”‚   â”‚   â”œâ”€â”€ CognitoAuthClient.java              (Feign Client para Cognito)
â”‚   â”‚   â”œâ”€â”€ CognitoAuthService.java             (Interface)
â”‚   â”‚   â””â”€â”€ CognitoAuthServiceImpl.java         (ImplementaciÃ³n)
â”‚   â”‚
â”‚   â””â”€â”€ questions/                               ğŸ“‹ Capacidad: Consultas de Preguntas
â”‚       â”œâ”€â”€ ExternalInsurabilityQuestionsClient.java
â”‚       â”œâ”€â”€ ExternalInsurabilityQuestionsService.java
â”‚       â””â”€â”€ ExternalInsurabilityQuestionsServiceImpl.java
â”‚
â”œâ”€â”€ organization/                                 ğŸ“Š Capacidad: OrganizaciÃ³n (USO INTERNO)
â”‚   â”œâ”€â”€ InsurabilityQuestionsOrganizationService.java       (Interface)
â”‚   â””â”€â”€ InsurabilityQuestionsOrganizationServiceImpl.java   (ImplementaciÃ³n)
â”‚
â”œâ”€â”€ validation/                                  âœ… Capacidad: ValidaciÃ³n (con subcapacidades)
â”‚   â”œâ”€â”€ InsurabilityValidationService.java      (Interface principal)
â”‚   â”œâ”€â”€ InsurabilityValidationServiceImpl.java  (Coordinador - 68 lÃ­neas)
â”‚   â”‚
â”‚   â”œâ”€â”€ rules/                                   ğŸ“‹ Subcapacidad: Reglas de Negocio
â”‚   â”‚   â”œâ”€â”€ InsurabilityValidationRulesService.java
â”‚   â”‚   â””â”€â”€ InsurabilityValidationRulesServiceImpl.java
â”‚   â”‚
â”‚   â””â”€â”€ storage/                                 ğŸ’¾ Subcapacidad: Almacenamiento
â”‚       â”œâ”€â”€ InsurabilityValidationStorageService.java
â”‚       â””â”€â”€ InsurabilityValidationStorageServiceImpl.java
â”‚
â”œâ”€â”€ InsurabilityQuestionsService.java            (Service Principal)
â””â”€â”€ InsurabilityQuestionsServiceImpl.java        (Orquesta capacidades)

dto/insurability/
â”œâ”€â”€ auth/                                        ğŸ” DTOs de AutenticaciÃ³n
â”‚   â””â”€â”€ CognitoTokenResponseDto.java            (Token OAuth2)
â”‚
â”œâ”€â”€ questions/                                   ğŸ“‹ DTOs de Preguntas
â”‚   â”œâ”€â”€ InsurabilityQuestionsRequestDto.java
â”‚   â”œâ”€â”€ InsurabilityQuestionDto.java
â”‚   â””â”€â”€ InsurabilityQuestionsResponseDto.java
â”‚
â”œâ”€â”€ validation/                                  âœ… DTOs de ValidaciÃ³n
â”‚   â”œâ”€â”€ InsurabilityValidationRequestDto.java
â”‚   â”œâ”€â”€ InsurabilityValidationResponseDto.java
â”‚   â”œâ”€â”€ PersonValidationDto.java
â”‚   â””â”€â”€ QuestionValidationDto.java
â”‚
â””â”€â”€ (raÃ­z)                                       ğŸ’¾ DTOs de Guardar
    â”œâ”€â”€ FormDto.java
    â”œâ”€â”€ InsurabilityRequestDto.java
    â””â”€â”€ InsurabilityResponseDto.java

mapper/insurability/
â”œâ”€â”€ validation/                                  âœ… Mapper de ValidaciÃ³n
â”‚   â””â”€â”€ InsurabilityValidationMapper.java       (Transforma DTOs a estructuras de persistencia)
â”‚
â””â”€â”€ (raÃ­z - si hay mappers generales del dominio)
    â””â”€â”€ InsurabilityMapper.java                 (Transformaciones comunes del dominio)

âš ï¸ NOTA: La capacidad `organization` NO requiere DTOs propios, 
usa los DTOs existentes de otras capacidades.
```

### Ejemplo 2: DecisiÃ³n y Extensibilidad

| Escenario | Estructura | CuÃ¡ndo |
|-----------|------------|--------|
| **Una capacidad** | `external/` raÃ­z | âœ… Simple, una responsabilidad |
| **â‰¥2 capacidades** | `external/auth/`, `external/questions/` | âœ… Mejor organizaciÃ³n |
| **Agregar capacidad** | `external/validation/` | âœ… Sin afectar existentes |

**Extensibilidad en servicio principal:**
```java
@Service
@RequiredArgsConstructor
public class InsurabilityQuestionsServiceImpl implements InsurabilityQuestionsService {
    private final CognitoAuthService cognitoAuthService;              // Existente
    private final ExternalInsurabilityQuestionsService questionsService; // Existente
    private final ExternalValidationService validationService;        // âœ… Nueva capacidad
}
```

### Ejemplo 3: Subcapacidades - Coordinador Delegando

**Estructura:**
```
service/insurability/validation/
â”œâ”€â”€ InsurabilityValidationServiceImpl.java (Coordinador - 68 lÃ­neas)
â”œâ”€â”€ rules/InsurabilityValidationRulesServiceImpl.java (Validaciones)
â””â”€â”€ storage/InsurabilityValidationStorageServiceImpl.java (Persistencia)
```

**Coordinador delega responsabilidades:**
```java
@Service
@RequiredArgsConstructor
public class InsurabilityValidationServiceImpl implements InsurabilityValidationService {
    private final InsurabilityValidationRulesService rulesService;      // âœ… Subcapacidad
    private final InsurabilityValidationStorageService storageService;  // âœ… Subcapacidad
    private final InsurabilityValidationMapper mapper;

    @Override
    public InsurabilityValidationResponseDto validateInsurabilityDeclaration(
            InsurabilityValidationRequestDto request) {
        rulesService.validateRequest(request);                          // âœ… Delega validaciÃ³n
        boolean isInsurable = rulesService.validatePersonsInsurability(request);
        Map<String, Object> stepData = mapper.buildStepData(request.getPersons(), isInsurable);
        storageService.saveValidationStep(stepData);                    // âœ… Delega persistencia
        return InsurabilityValidationResponseDto.builder().insurable(isInsurable).build();
    }
}
```

**Beneficios:** 68 vs 126 lÃ­neas (46% reducciÃ³n), alta cohesiÃ³n, testeable, reutilizable, escalable

### Ejemplo 4: OrganizaciÃ³n por Dominio en Validation y Transactional

**Problema:** Capacidades `validation/` y `transactional/` con mÃºltiples responsabilidades mezcladas (validaciones de productos, usuarios, carritos en un solo servicio)

**SoluciÃ³n:** Organizar por dominio en subcarpetas sin coordinadores intermedios

**Estructura organizada por dominio:**

```
service/cartitem/
â”œâ”€â”€ validation/                                      âœ… Validaciones por dominio
â”‚   â”œâ”€â”€ product/
â”‚   â”‚   â”œâ”€â”€ CartItemProductValidationService.java
â”‚   â”‚   â””â”€â”€ CartItemProductValidationServiceImpl.java
â”‚   â”‚       â€¢ validateProductExists()
â”‚   â”‚       â€¢ validateProductActive()
â”‚   â”‚
â”‚   â”œâ”€â”€ user/
â”‚   â”‚   â”œâ”€â”€ CartItemUserValidationService.java
â”‚   â”‚   â””â”€â”€ CartItemUserValidationServiceImpl.java
â”‚   â”‚       â€¢ validateUserRoleExists()
â”‚   â”‚       â€¢ getUserRoleIdFromDocument()
â”‚   â”‚       â€¢ getUserRoleIdFromEmail()
â”‚   â”‚       â€¢ validateUserHasClientRole()
â”‚   â”‚
â”‚   â”œâ”€â”€ cart/
â”‚   â”‚   â”œâ”€â”€ CartItemCartValidationService.java
â”‚   â”‚   â””â”€â”€ CartItemCartValidationServiceImpl.java
â”‚   â”‚       â€¢ validateCartExists()
â”‚   â”‚       â€¢ validateOrCreateCart()
â”‚   â”‚       â€¢ validateProductNotInCart()
â”‚   â”‚       â€¢ validateItemBelongsToUser()
â”‚   â”‚
â”‚   â””â”€â”€ common/
â”‚       â”œâ”€â”€ CartItemCommonValidationService.java
â”‚       â””â”€â”€ CartItemCommonValidationServiceImpl.java
â”‚           â€¢ validateQuantity()
â”‚
â”œâ”€â”€ transactional/                                   âœ… Acceso a datos por dominio
â”‚   â”œâ”€â”€ cart/
â”‚   â”‚   â”œâ”€â”€ CartItemCartTransactionalService.java
â”‚   â”‚   â””â”€â”€ CartItemCartTransactionalServiceImpl.java
â”‚   â”‚       â€¢ findOrCreateCart()
â”‚   â”‚       â€¢ findCartById()
â”‚   â”‚       â€¢ findCartItemById()
â”‚   â”‚       â€¢ saveCartItem()
â”‚   â”‚       â€¢ deleteCartItem()
â”‚   â”‚
â”‚   â”œâ”€â”€ product/
â”‚   â”‚   â”œâ”€â”€ CartItemProductTransactionalService.java
â”‚   â”‚   â””â”€â”€ CartItemProductTransactionalServiceImpl.java
â”‚   â”‚       â€¢ findProductById()
â”‚   â”‚
â”‚   â””â”€â”€ user/
â”‚       â”œâ”€â”€ CartItemUserTransactionalService.java
â”‚       â””â”€â”€ CartItemUserTransactionalServiceImpl.java
â”‚           â€¢ existsUserRoleById()
â”‚           â€¢ findUserRoleById()
â”‚           â€¢ findDocumentTypeByCodigo()
â”‚           â€¢ findUserByEmail()
â”‚
â”œâ”€â”€ CartItemService.java
â””â”€â”€ CartItemServiceImpl.java  â† Usa directamente subcapacidades
```

**ServiceImpl usa subcapacidades directamente (SIN coordinador intermedio):**

```java
@Service
@RequiredArgsConstructor
public class CartItemServiceImpl implements CartItemService {

    // âœ… InyecciÃ³n directa de subcapacidades - Sin coordinadores
    private final CartItemCartTransactionalService transactionalService;
    private final CartItemCartValidationService cartValidationService;
    private final CartItemProductValidationService productValidationService;
    private final CartItemCommonValidationService commonValidationService;
    private final CartItemMapper cartItemMapper;
    private final AuthUserService authUserService;

    @Override
    @Transactional
    public Response<String> addItemToCart(CartItemRequest request) {
        Integer userRoleId = authUserService.getAuthenticatedUserRoleId();
        Cart cart = transactionalService.findOrCreateCart(userRoleId);
        
        // âœ… Uso directo de subcapacidades por dominio
        Product product = productValidationService.validateProductExists(request.getProductId());
        productValidationService.validateProductActive(product);
        commonValidationService.validateQuantity(request.getQuantity());
        
        CartItem cartItem = createOrUpdateCartItem(request, cart, product);
        transactionalService.saveCartItem(cartItem);
        
        return Response.success(SUCCESS_CART_ITEM_ADDED);
    }
}
```

**Validation subcapacidades inyectan Transactional subcapacidades:**

```java
@Service
@RequiredArgsConstructor
public class CartItemProductValidationServiceImpl 
        implements CartItemProductValidationService {
    
    // âœ… InyecciÃ³n directa de transactional especÃ­fico
    private final CartItemProductTransactionalService transactionalService;

    @Override
    public Product validateProductExists(Integer productId) {
        return transactionalService.findProductById(productId)
                .orElseThrow(() -> new ProductException(ERROR_PRODUCT_NOT_FOUND));
    }
}

@Service
@RequiredArgsConstructor
public class CartItemUserValidationServiceImpl 
        implements CartItemUserValidationService {
    
    // âœ… InyecciÃ³n directa de transactional especÃ­fico
    private final CartItemUserTransactionalService transactionalService;

    @Override
    public void validateUserRoleExists(Integer userRoleId) {
        if (!transactionalService.existsUserRoleById(userRoleId)) {
            throw new CartException(ERROR_USER_ROLE_NOT_FOUND);
        }
    }
}
```

**Criterios para organizaciÃ³n por dominio:**
- âœ… Capacidad con mÃ©todos de mÃºltiples dominios (productos, usuarios, carritos)
- âœ… Cada dominio tiene â‰¥2 mÃ©todos relacionados
- âœ… Dominios independientes entre sÃ­
- âœ… ServiceImpl usa directamente subcapacidades (sin coordinador)
- âŒ NO crear coordinador intermedio que solo delega

**Beneficios:**

| Aspecto | Antes (MonolÃ­tico) | DespuÃ©s (Por Dominio) | Mejora |
|---|---|---|---|
| **OrganizaciÃ³n** | 214 lÃ­neas validation + 165 transactional | 4 validation + 3 transactional | âœ… Alta cohesiÃ³n |
| **Archivos eliminados** | 2 coordinadores intermedios | 0 coordinadores | âœ… -4 archivos |
| **Responsabilidades** | Todas mezcladas | Separadas por dominio | âœ… SRP aplicado |
| **Capas indirecciÃ³n** | 2 (Service â†’ Coord â†’ Subcap) | 1 (Service â†’ Subcap) | âœ… Sin overhead |
| **Inyecciones** | 1 coordinador | 3-4 subcapacidades | âœ… ExplÃ­cito |
| **Testeable** | Mock coordinador | Mock por dominio | âœ… Tests especÃ­ficos |
| **Reutilizable** | Acoplado | Independiente | âœ… Reusable |

**Dominios comunes en validation/transactional:**
- `product/` - ValidaciÃ³n y acceso a productos
- `user/` - ValidaciÃ³n y acceso a usuarios/roles
- `cart/` - ValidaciÃ³n y acceso a carritos/items
- `common/` - Validaciones genÃ©ricas (solo en validation)

### Ejemplo 4.1: Caso Real - RefactorizaciÃ³n de User por Dominios

**Escenario:** MÃ³dulo User con servicios monolÃ­ticos de validation y transactional â†’ OrganizaciÃ³n por dominios

**âŒ ANTES - Servicios MonolÃ­ticos (4 archivos, 257 lÃ­neas):**

```
service/user/
â”œâ”€â”€ validation/
â”‚   â”œâ”€â”€ UserValidationService.java              (Interface - 110 lÃ­neas)
â”‚   â””â”€â”€ UserValidationServiceImpl.java          (ImplementaciÃ³n - 153 lÃ­neas)
â”‚       â€¢ validateEmailNotExists()              [user domain]
â”‚       â€¢ validateDocumentType()                [document domain]
â”‚       â€¢ validatePasswordNotEmpty()            [common domain]
â”‚       â€¢ findRoleById()                        [role domain]
â”‚       â€¢ findUserByIdOrThrow()                 [user domain]
â”‚       â€¢ findUserByEmailOrThrow()              [user domain]
â”‚       â€¢ findUserStatusByName()                [status domain]
â”‚       â€¢ validateDocumentCombination()         [user domain]
â”‚       â€¢ validateAndFindRolesByIds()           [role domain]
â”‚       â€¢ validateRolesCombination()            [role domain]
â”‚
â”œâ”€â”€ transactional/
â”‚   â”œâ”€â”€ UserTransactionalService.java           (Interface - 99 lÃ­neas)
â”‚   â””â”€â”€ UserTransactionalServiceImpl.java       (ImplementaciÃ³n - 103 lÃ­neas)
â”‚       â€¢ existsByEmail()                       [user domain]
â”‚       â€¢ findDocumentTypeById()                [document domain]
â”‚       â€¢ findRoleById()                        [role domain]
â”‚       â€¢ findUserById()                        [user domain]
â”‚       â€¢ findUserByEmail()                     [user domain]
â”‚       â€¢ findUserStatusByName()                [status domain]
â”‚       â€¢ findByDocumentTypeAndNumber()         [user domain]
â”‚       â€¢ saveUser()                            [user domain]
â”‚       â€¢ saveAllUserRoles()                    [role domain]
â”‚       â€¢ deleteAllUserRoles()                  [role domain]
â”‚
â”œâ”€â”€ UserService.java
â””â”€â”€ UserServiceImpl.java                         (Inyecta 2 servicios monolÃ­ticos)
```

**UserServiceImpl (antes):**
```java
@Service
@RequiredArgsConstructor
public class UserServiceImpl implements UserService {
    private final UserTransactionalService transactionalService;  // âŒ MonolÃ­tico
    private final UserValidationService validationService;        // âŒ MonolÃ­tico
    private final UserMapper userMapper;
    private final PasswordEncoder passwordEncoder;

    @Override
    @Transactional
    public UserResponse createUser(UserRequest request) {
        validationService.validateEmailNotExists(request.getEmail());
        validationService.validatePasswordNotEmpty(request.getPassword());
        validationService.validateDocumentCombination(...);
        
        DocumentType documentType = validationService.validateDocumentType(...);
        java.util.List<Role> roles = validationService.validateAndFindRolesByIds(...);
        validationService.validateRolesCombination(roles);
        UserStatus userStatus = validationService.findUserStatusByName("Activo");
        
        User user = userMapper.toEntity(...);
        User savedUser = transactionalService.saveUser(user);
        
        java.util.List<UserRole> userRoles = userMapper.buildUserRoles(...);
        java.util.List<UserRole> savedUserRoles = transactionalService.saveAllUserRoles(userRoles);
        // ...
    }
}
```

**âœ… DESPUÃ‰S - Organizado por Dominios (18 archivos + coordinador):**

```
service/user/
â”œâ”€â”€ validation/                                   âœ… Validaciones por dominio
â”‚   â”œâ”€â”€ user/
â”‚   â”‚   â”œâ”€â”€ UserUserValidationService.java
â”‚   â”‚   â””â”€â”€ UserUserValidationServiceImpl.java
â”‚   â”‚       â€¢ validateEmailNotExists()
â”‚   â”‚       â€¢ findUserByIdOrThrow()
â”‚   â”‚       â€¢ findUserByEmailOrThrow()
â”‚   â”‚       â€¢ validateDocumentCombination()
â”‚   â”‚
â”‚   â”œâ”€â”€ document/
â”‚   â”‚   â”œâ”€â”€ UserDocumentValidationService.java
â”‚   â”‚   â””â”€â”€ UserDocumentValidationServiceImpl.java
â”‚   â”‚       â€¢ validateDocumentType()
â”‚   â”‚
â”‚   â”œâ”€â”€ role/
â”‚   â”‚   â”œâ”€â”€ UserRoleValidationService.java
â”‚   â”‚   â””â”€â”€ UserRoleValidationServiceImpl.java
â”‚   â”‚       â€¢ findRoleById()
â”‚   â”‚       â€¢ validateAndFindRolesByIds()
â”‚   â”‚       â€¢ validateRolesCombination()
â”‚   â”‚
â”‚   â”œâ”€â”€ status/
â”‚   â”‚   â”œâ”€â”€ UserStatusValidationService.java
â”‚   â”‚   â””â”€â”€ UserStatusValidationServiceImpl.java
â”‚   â”‚       â€¢ findUserStatusByName()
â”‚   â”‚
â”‚   â””â”€â”€ common/
â”‚       â”œâ”€â”€ UserCommonValidationService.java
â”‚       â””â”€â”€ UserCommonValidationServiceImpl.java
â”‚           â€¢ validatePasswordNotEmpty()
â”‚
â”œâ”€â”€ transactional/                                âœ… Acceso a datos por dominio
â”‚   â”œâ”€â”€ user/
â”‚   â”‚   â”œâ”€â”€ UserUserTransactionalService.java
â”‚   â”‚   â””â”€â”€ UserUserTransactionalServiceImpl.java
â”‚   â”‚       â€¢ existsByEmail()
â”‚   â”‚       â€¢ findUserById()
â”‚   â”‚       â€¢ findUserByEmail()
â”‚   â”‚       â€¢ findByDocumentTypeAndNumber()
â”‚   â”‚       â€¢ saveUser()
â”‚   â”‚
â”‚   â”œâ”€â”€ document/
â”‚   â”‚   â”œâ”€â”€ UserDocumentTransactionalService.java
â”‚   â”‚   â””â”€â”€ UserDocumentTransactionalServiceImpl.java
â”‚   â”‚       â€¢ findDocumentTypeById()
â”‚   â”‚
â”‚   â”œâ”€â”€ role/
â”‚   â”‚   â”œâ”€â”€ UserRoleTransactionalService.java
â”‚   â”‚   â””â”€â”€ UserRoleTransactionalServiceImpl.java
â”‚   â”‚       â€¢ findRoleById()
â”‚   â”‚       â€¢ saveAllUserRoles()
â”‚   â”‚       â€¢ deleteAllUserRoles()
â”‚   â”‚
â”‚   â””â”€â”€ status/
â”‚       â”œâ”€â”€ UserStatusTransactionalService.java
â”‚       â””â”€â”€ UserStatusTransactionalServiceImpl.java
â”‚           â€¢ findUserStatusByName()
â”‚
â”œâ”€â”€ UserService.java
â””â”€â”€ UserServiceImpl.java  â† Inyecta subcapacidades directamente
```

**UserServiceImpl (despuÃ©s):**
```java
@Service
@RequiredArgsConstructor
public class UserServiceImpl implements UserService {
    // âœ… Validation subcapacidades (5 dominios)
    private final UserUserValidationService userValidationService;
    private final UserDocumentValidationService documentValidationService;
    private final UserRoleValidationService roleValidationService;
    private final UserStatusValidationService statusValidationService;
    private final UserCommonValidationService commonValidationService;

    // âœ… Transactional subcapacidades (2 dominios usados)
    private final UserUserTransactionalService userTransactionalService;
    private final UserRoleTransactionalService roleTransactionalService;

    private final UserMapper userMapper;
    private final PasswordEncoder passwordEncoder;

    @Override
    @Transactional
    public UserResponse createUser(UserRequest request) {
        // âœ… Llama directamente a subcapacidades especÃ­ficas por dominio
        userValidationService.validateEmailNotExists(request.getEmail());
        commonValidationService.validatePasswordNotEmpty(request.getPassword());
        userValidationService.validateDocumentCombination(...);
        
        DocumentType documentType = documentValidationService.validateDocumentType(...);
        List<Role> roles = roleValidationService.validateAndFindRolesByIds(...);
        roleValidationService.validateRolesCombination(roles);
        UserStatus userStatus = statusValidationService.findUserStatusByName("Activo");
        
        User user = userMapper.toEntity(...);
        User savedUser = userTransactionalService.saveUser(user);
        
        List<UserRole> userRoles = userMapper.buildUserRoles(...);
        List<UserRole> savedUserRoles = roleTransactionalService.saveAllUserRoles(userRoles);
        // ...
    }
}
```

**ğŸ“Š MÃ©tricas de Mejora:**

| Aspecto | Antes | DespuÃ©s | Beneficio |
|---|---|---|---|
| **Archivos** | 4 (2 validation + 2 transactional) | 18 (9 validation + 9 transactional) | âœ… OrganizaciÃ³n por dominio |
| **LÃ­neas validation** | 263 lÃ­neas (monolÃ­tico) | 5 archivos separados | âœ… Alta cohesiÃ³n |
| **LÃ­neas transactional** | 202 lÃ­neas (monolÃ­tico) | 4 dominios independientes | âœ… Responsabilidades claras |
| **Inyecciones ServiceImpl** | 2 servicios genÃ©ricos | 7 subcapacidades especÃ­ficas | âœ… ExplÃ­cito |
| **Dominios identificables** | âŒ Mezclados | âœ… 5 dominios claros | âœ… SRP |
| **ReutilizaciÃ³n** | âŒ Acoplado | âœ… Subcapacidades independientes | âœ… Testeable |

**ğŸ¯ Beneficios Logrados:**

1. âœ… **Alta cohesiÃ³n**: Cada dominio agrupa mÃ©todos relacionados (user, document, role, status, common)
2. âœ… **SRP aplicado**: Una responsabilidad por archivo (validaciÃ³n de usuarios, acceso a roles, etc.)
3. âœ… **Sin coordinadores intermedios**: ServiceImpl usa subcapacidades directamente
4. âœ… **Testeable**: Mock por dominio especÃ­fico
5. âœ… **Escalable**: Agregar nuevos dominios sin tocar existentes
6. âœ… **Consistente**: Misma estructura que otros mÃ³dulos (CartItem)

**âš ï¸ Lecciones Aprendidas:**

- ğŸš¨ Servicios validation/transactional monolÃ­ticos con mÃºltiples dominios **violan** SRP
- ğŸš¨ Mezclar dominios en un solo servicio dificulta mantenimiento y testing
- âœ… Organizar por dominio (user/, document/, role/, status/, common/) **es obligatorio** cuando hay â‰¥2 dominios
- âœ… ServiceImpl debe inyectar subcapacidades directamente (no coordinadores)
- âœ… Cada dominio puede evolucionar independientemente

**ğŸ“Œ Criterios para organizaciÃ³n obligatoria por dominios:**
- âœ… Validation/Transactional con mÃ©todos de â‰¥2 dominios diferentes
- âœ… Cada dominio tiene â‰¥2 mÃ©todos relacionados
- âœ… Dominios son independientes entre sÃ­
- âœ… ServiceImpl usa directamente subcapacidades (sin coordinador intermedio)

### âš ï¸ Caso Especial CRUD: SeparaciÃ³n Obligatoria

**Problema:** `ServiceImpl` con â‰¥3 mÃ©todos auxiliares privados (476 lÃ­neas, 12 mÃ©todos privados)

**SoluciÃ³n:** Separar en capacidades `validation/` + `builder/`

| MÃ©todos Privados | Capacidad Destino |
|------------------|-------------------|
| `validateEmailNotExists()`, `validateDocumentType()`, `validatePasswordNotEmpty()`, `findRoleById()`, `findUserByIdOrThrow()`, `validateUpdateRequest()`, `handleDataIntegrityViolation()` | `validation/UserValidationServiceImpl` (114 lÃ­neas) |
| `buildUserFromRequest()`, `buildSpecification()`, `updateUserFields()` | `builder/UserBuilderServiceImpl` (106 lÃ­neas) |

**Coordinador refactorizado (245 lÃ­neas, CERO mÃ©todos privados):**
```java
@Service
@RequiredArgsConstructor
public class UserServiceImpl implements UserService {
    private final UserRepository userRepository;
    private final UserMapper userMapper;
    private final UserValidationService validationService;   // âœ… Capacidad
    private final UserBuilderService builderService;         // âœ… Capacidad

    @Override
    @Transactional
    public UserResponseDto createUser(UserRequestDto request) {
        validationService.validateEmailNotExists(request.getEmail());     // âœ… Delega
        validationService.validateDocumentType(request.getDocumentType());// âœ… Delega
        validationService.validatePasswordNotEmpty(request.getPassword());// âœ… Delega
        Role role = validationService.findRoleById(request.getRoleId());  // âœ… Delega
        User user = builderService.buildUserFromRequest(request, role);   // âœ… Delega
        return userMapper.toResponseDto(userRepository.save(user));
    }
    // ... resto mÃ©todos interfaz (8 total) - CERO mÃ©todos privados auxiliares
}
```

**MÃ©tricas:**

| Aspecto | Antes | DespuÃ©s | Mejora |
|---------|-------|---------|--------|
| LÃ­neas ServiceImpl | 476 | 245 | 48% â†“ |
| MÃ©todos privados | 12 | 0 | 100% â†“ |
| Responsabilidades | 3 mezcladas | 1 clara | Alta cohesiÃ³n |

**Criterios obligatorios:**
- ğŸš¨ â‰¥3 mÃ©todos auxiliares â†’ Separar capacidades
- ğŸš¨ ServiceImpl > 300 lÃ­neas â†’ Refactorizar
- âœ… `validate*`, `find*OrThrow` â†’ `validation/`
- âœ… `build*`, `update*Fields` â†’ `builder/`

## ğŸš« Restricciones

1. **NO** mantener â‰¥3 mÃ©todos auxiliares privados en `ServiceImpl` ni mÃ©todos de validaciÃ³n/construcciÃ³n (separar en capacidades OBLIGATORIO)
2. **NO** crear coordinadores intermedios que solo delegan (ej: `ValidationService` que delega a `ProductValidationService`, `UserValidationService`) - ServiceImpl debe inyectar subcapacidades directamente
3. **NO** mantener servicios validation/transactional monolÃ­ticos con mÃ©todos de â‰¥2 dominios diferentes - OBLIGATORIO organizar por dominio en subcarpetas
3. **NO** poner Request/Response principales en `dto/` (deben ir en `models/` SIN sufijo "Dto")
4. **NO** usar sufijo "Dto" en Request/Response principales en `models/`
5. **NO** mezclar Request/Response con DTOs auxiliares en la misma carpeta
6. **NO** mezclar capacidades en la misma carpeta ni usar nombres genÃ©ricos (`common`, `utils`) - agrupar por capacidad de negocio (excepto `common/` para validaciones genÃ©ricas)
7. **NO** duplicar cÃ³digo entre capacidades ni crear dependencias circulares
8. **NO** crear estructura profunda (mÃ¡ximo 2 niveles, 3 con subcapacidades por dominio)
9. **NO** tener estructura inconsistente entre `service/`, `dto/` y `mapper/`
10. **NO** crear mappers en raÃ­z cuando servicio tiene subcarpetas ni incluir lÃ³gica de negocio en mappers
11. **NO** usar prefijos redundantes en carpetas (`auth/AuthTokenDto` â†’ `auth/TokenDto`)
12. **NO** crear subcapacidades para mÃ©todos pequeÃ±os (< 50 lÃ­neas) o lÃ³gica fuertemente acoplada
13. **NO** omitir `@Component` en mappers
14. **NO** dejar carpetas vacÃ­as o cÃ³digo duplicado
15. **NO** mezclar mÃ©todos de mÃºltiples dominios en un solo servicio (product, user, cart deben estar separados)

## âœ… ValidaciÃ³n AutomÃ¡tica

Cursor debe detectar:

**Servicios CRUD (CRÃTICO):**
- âŒ `ServiceImpl` con â‰¥3 mÃ©todos auxiliares privados sin separar en capacidades
- âŒ MÃ©todos de validaciÃ³n (`validate*`, `find*OrThrow`, `handle*Violation`) en `ServiceImpl`
- âŒ MÃ©todos de construcciÃ³n (`build*`, `update*Fields`) en `ServiceImpl`
- âŒ `ServiceImpl` > 300 lÃ­neas sin refactorizar

**Coordinadores Intermedios (CRÃTICO):**
- âŒ Servicios que solo delegan sin lÃ³gica adicional (ej: `ValidationServiceImpl` con 100% delegaciÃ³n)
- âŒ ServiceImpl inyectando coordinadores en lugar de subcapacidades especÃ­ficas
- âŒ MÃºltiples capas de indirecciÃ³n innecesarias (Service â†’ Coordinador â†’ Subcapacidad)
- âŒ Archivos con nombres genÃ©ricos que solo delegan (`*CoordinatorService`, `*FacadeService`)

**OrganizaciÃ³n por Dominio (CRÃTICO):**
- âŒ MÃ©todos de â‰¥2 dominios mezclados en un solo servicio validation/transactional monolÃ­tico
- âŒ Falta de subcarpetas por dominio cuando hay â‰¥2 dominios (product, user, cart, document, role, status, common)
- âŒ Servicios validation sin separar por dominio cuando hay mÃ©todos de product + user + cart + document + role
- âŒ Servicios transactional sin separar por dominio cuando hay mÃ©todos de mÃºltiples entidades
- âŒ Nombres de mÃ©todos que indican mÃºltiples dominios sin organizar (validateProduct, validateUser, validateCart en un mismo servicio)

**Models vs DTOs:**
- âŒ Request/Response principales con sufijo "Dto" (debe ser sin sufijo en `models/`)
- âŒ Request/Response en `dto/` en lugar de `models/`
- âŒ DTOs auxiliares sin sufijo "Dto"
- âŒ Mezcla de Request/Response con DTOs auxiliares en misma carpeta

**Capacidades External:**
- âŒ MÃºltiples capacidades (â‰¥2) en `external/` sin subcarpetas o estructura inconsistente
- âŒ DTOs/Mappers sin reflejar estructura de servicio o mezclados entre capacidades
- âŒ Nombres genÃ©ricos (`folder1`, `utils`) o imports incorrectos (excepto `common/` para validaciones genÃ©ricas)
- âŒ Dependencias circulares entre capacidades o subcapacidades
- âŒ Mappers sin `@Component`, con lÃ³gica de negocio o en raÃ­z incorrecta
- âŒ Subcapacidades < 50 lÃ­neas o servicio coordinador con lÃ³gica de negocio
- âŒ Carpetas vacÃ­as, cÃ³digo duplicado o prefijos redundantes

## ğŸ¯ Objetivo + Regla de Oro

**Objetivo**: Organizar servicios externos, DTOs y Mappers por capacidades de negocio para maximizar cohesiÃ³n, minimizar acoplamiento y facilitar escalabilidad. **OBLIGATORIO**: Separar capacidades en servicios CRUD con â‰¥3 mÃ©todos auxiliares.

**REGLA DE ORO**: "Una capacidad = Una carpeta. **Request/Response en `models/` SIN "Dto", DTOs auxiliares en `dto/` CON "Dto"**. **ServiceImpl con â‰¥3 mÃ©todos privados â†’ OBLIGATORIO SEPARAR en `validation/` + `builder/`**. **Validation/Transactional con â‰¥2 dominios â†’ OBLIGATORIO organizar por dominio (user/, document/, role/, status/, product/, cart/, common/) SIN coordinador intermedio**. ServiceImpl inyecta subcapacidades especÃ­ficas directamente (NO coordinadores). Si â‰¥2 capacidades external, usar subcarpetas (`auth/`, `questions/`). Si una capacidad tiene mÃºltiples responsabilidades (>50 lÃ­neas), crear subcapacidades (`validation/rules/`, `validation/storage/`). Cada cambio afecta solo una carpeta."

---

> **Ver tambiÃ©n**:
> - [servicios-01-creacion-servicios.mdc](./servicios-01-creacion-servicios.mdc) - Arquitectura en capas
> - [servicios-02-feign-client.mdc](./servicios-02-feign-client.mdc) - Feign Clients
> - [servicios-05-dtos.mdc](./servicios-05-dtos.mdc) - Estructura de DTOs
